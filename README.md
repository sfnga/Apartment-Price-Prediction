# Apartment-Price-Prediction
Предсказание примерной рыночной стоимости квартир на рынке вторичного жилья Москвы, используя данные с сайта Авито

<table>
  <tr>
    <th>Ссылка</th>
    <th colspan="2">Параметры квартиры</th>
    <th colspan="2">Стоимость</th>
    <th colspan="2">Предсказанная стоимость</th>
  </tr>
  <tr>
    <td rowspan="6"><a href="https://www.avito.ru/moskva/kvartiry/2-k._kvartira_537m_917et._2685290861">link1</a></td>
    <td>Адрес</td>
    <td>Новокосинская ул., 17к3</td>
    <td rowspan="3"> Квадратный метр</td>
    <td rowspan="3"> 233 тыс. ₽</td>
    <td rowspan="3">Квадратный метр</td>
    <td rowspan="3">228 тыс. ₽</td>
  </tr>
  <tr>
    <td>Общая площадь </td>
    <td>53.7 м² </td>
  </tr>
   <tr>
    <td>Количество комнат </td>
    <td>2</td>
  </tr>
  <tr>
    <td>Ремонт</td>
    <td>косметический</td>
    <td rowspan="3"> Общая стоимость</td>
    <td rowspan="3"> 12.5 млн. ₽</td>
    <td rowspan="3">Общая стоимость</td>
    <td rowspan="3">12.290 млн. ₽</td>
  </tr>
   <tr>
      <td>Этаж</td>
     <td>9/17</td>
    </tr>
  <tr>
    <td>Тип дома </td>
    <td>панельный</td>
  </tr>
</table>


## Этапы решения задачи
### [Сбор данных](https://github.com/sfnga/Apartment-Price-Prediction/tree/main/parsing)
*  Помимо объявлений о продаже квартир спарсил следующие данные:
   * Координаты всех школ Москвы и области (планировал использовать расстояние от квартиры до ближайшей школы, но затем после проверки признаков понял, что этот признак ничего не дает)
   * [Рейтинги районов Москвы](https://www.domofond.ru/city-ratings/moskva-c3584)
*  для парсинга использовал Beautifoul Soup, для хранения данных - sqlite3
*  На карте отмечены спаршенные объявления: 

![Карта](https://imgur.com/v7cU1eX.jpg)
### [Предобработка данных](https://github.com/sfnga/Apartment-Price-Prediction/blob/main/preprocessing/preprocessing.ipynb)
*  изначально я парсил данные о продаже новостроек и квартир на вторичном рынке, однако после изучения формирования цен на квартиры решил отказаться от использования данных о новостройках по причине того, что стоимость квартир в новостройках в среднем ниже, чем во вторичном жилье. Кроме того, квартиры в новостройках могут продаваться на этапе котлована или на начальном этапе строительства, что также уменьшает цену.
*  Удалил дубликаты. Дубликаты искал по подмножеству признаков Адрес, Этаж, Количество комнат, Общая площадь
*  Удалил объявления о продаже квартир в домах, которые будут сносить, поскольку стоимость квартир в таких домах значительно ниже
*  Удалил обявления о продаже квартир, выставленных на аукцион, [поскольку](https://xn--h1alcedd.xn--d1aqf.xn--p1ai/instructions/kak-kupit-kvartiru-cherez-aukczion/) их цена может быть ниже рыночной. Также удалил объявления о продаже доли в квартире
*  Удалил объявления о продаже квартир, находящихся на расстоянии больше 25 километров от центра Москвы, например, в Зеленограде или Селятино, поскольку цены на квадратный метр там гораздо ниже, чем в среднем по Москве. 
На графике приведено сравнение цен на квадратный метр в Москве и Зеленограде, синий цвет - Зеленоград красный - Москва.
![Москва-Зеленоград](https://www.irn.ru/graph/services/compare.php?period=2&index=IS&grnum=1&currency=0&mos=on&geo_list=122)
*  Пробовал заполнять пропущенные значения в жилой площади и площади кухни с использованием данных об общей площади и количестве комнат, обучая линейную регрессию или алгоритм k-ближайших соседей, но это только ухудшило метрику, в первом случае на ~0.001, во втором - на ~0.0005
*  Предобработал выбросы в признаках общая площадь, жилая площадь, площадь кухни, высота потолков, год постройки
### [Создание признаков](https://github.com/sfnga/Apartment-Price-Prediction/blob/main/preprocessing/feature_engeneering.ipynb)
* Используя геокодер добавил признак район (оказался самым полезным)
* Добавил [рейтинги](https://www.domofond.ru/city-ratings/moskva-c3584) районов
* Расстояние до Кремля и расстояния до станций кольцевой линии метро
* Кластеризация по координатам
* Кластеризация по общей площади
* Для каждого значения количества комнат посчитал минимальное, максимальное и среднее значение общей площади. И добавил признаки отношение общей площади к минимальной, максимальной, средней по группе а также их разность
### [Построение модели](https://github.com/sfnga/Apartment-Price-Prediction/tree/main/models)
*  Данные были собраны преимущественно за декабрь 2022 года и январь 2023 года. За этот перид цена на квадратный метр менялась незначительно, поэтому модель тестировалась с использованием обычной перекрестной проверки на 5 фолдах, ~3500 записей использовал в качестве отложенной выборки для финальной проверки модели![Цены по времени](https://www.irn.ru/graph/services/image.php?macrogeo=0&class=all&type=1&period=2&grnum=1&currency=0)
*  Построил базовое решение: 
   * сгруппировал объявления по кластеру общей площади и посчитал медиану для каждого кластера: MAPE = 27.4%
   * сгруппировал объявления по кластеру координат и посчитал медиану для каждого кластера: MAPE = 20.3%
   * сгруппировал объявления по кластеру координат, кластеру общей площади, количеству комнат и посчитал медиану для каждого кластера: MAPE = 16.7%
*  [Обучил](https://github.com/sfnga/Apartment-Price-Prediction/blob/main/models/baseline.ipynb) LightGBM на всех признаках. Гиперпараметры, которые вносили наибольший вклад в улучшение качества модели: feature_fraction и lambda_l2. Получил значение MAPE = 12.5% на кросс-валидации и MAPE = 11.5% на отложенной выборке
*  Для отбора признаков использовал [важность признаков на основе перестановки](https://github.com/sfnga/Apartment-Price-Prediction/blob/main/feature_selection/permutation_importance.ipynb).  Признаки ремонт, количество комнат, общая площадь, этаж, количество этажей в доме, адрес (район) есть указаны в каждом объявлении, кроме того они имеют лучшую важность на основе перестановки. Поэтому решил использовать эти признаки в качестве входных данных от пользователя, а затем, опираясь, на важность функции на основе перестановки, добавить признаки расстояние до метро Краснопресненская, Киевская, расстояние до Кремля, кластер координат, 3 ближайших станции метро, общая площадь минус минимальная площадь для данного количества комнат.
*  Также для отбора признаков использовал рекурсивное удаление признаков (реализации scikit-learn) и жадное добавление (перебирал все признаки и добавлял признак, дающий наибольшее уменьшение ошибки). Но в первом случае качество не сильно улучшалось по сравнению с базовым решением, а во втором - на добавление одного признака требовалось 3-5 часов, поэтому в дальнейшем отказался от этих методов
### Пути для улучшения:
*  Использовать большее количество данных 
*  Использовать данные с сайта [минжкх](https://mingkh.ru/) для получения детальной информации о доме
*  Ипользовать mean encoding для кодирования некоторых категориальных признаков (пробовал кодировать количество комнат, но это только увеличило ошибку)
